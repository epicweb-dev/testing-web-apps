# HTTP Mocks

👨‍💼 Your co-worker added a tiny bit to the test you wrote. They added submitting
the form. Unfortunately, we pay actual money for every email we send through
[Mailgun](https://www.mailgun.com). We definitely do not want to send _real_
emails as a part of our automated test suite. In fact, it's been really annoying
to have to do that during development as well. So, instead of hitting Mailgun's
API to send an email, we're going to intercept that request during development
and testing to prevent it from actually sending an email and instead log the
email contents to the console.

🦉 I've got some words about this...

<callout-danger>
	Whenever you make a fake version of something during testing, you're losing
	confidence!
</callout-danger>

Make certain there's a legitimate benefit for that cost of confidence. Making a
fake version of something in testing is called "mocking" and is often necessary,
but goes against the principle of ensuring your tests resemble the way the
software is used.

Read more about this in [The Merits of Mocking](https://kentcdodds.com/blog/the-merits-of-mocking).

👨‍💼 Thanks Olivia... Back to the task! We have a number of things we need done.
We'll list them out here and go into detail below:

1. We've already installed [MSW](https://mswjs.io/), but it needs to be
   configured.
2. Enable the mocks when starting up the app.
3. Modify our dev script and create a new start script.
4. Update our playwright config to use the new start script.

## Configuring MSW

First, <InlineFile file="mocks/index.ts">Create `mocks/index.ts`</InlineFile>
and get MSW set up with this:

```ts
import { setupServer } from 'msw/node'
import closeWithGrace from 'close-with-grace'

// TODO: add handlers here
const server = setupServer()

server.listen({ onUnhandledRequest: 'warn' })
console.info('🔶 Mock server installed')

closeWithGrace(() => {
	server.close()
})
```

This is the basic start to configuring MSW. Next, we need to intercept requests
that are made to the Mailgun API. The URL for that can be
found in <InlineFile file="app/utils/email.server.ts" /> and is:
`https://api.mailgun.net/v3/:domain/messages`. So, we'll use `msw`'s `rest`
utility to intercept requests to that URL and respond with a very similar
response as the real Mailgun API.
